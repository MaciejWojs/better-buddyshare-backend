listen              1935;
listen              80;
max_connections     1000;
daemon           off;

http_api {
    enabled         on;
    listen          1985;
}

http_server {
    enabled         on;
    listen          8080;
    dir             ./objs/nginx/html;
}

rtc_server {
    enabled         on;
    listen          8000;
    # candidate       srs; # adres, który inne kontenery znają
    # Zmień na publiczny adres IP serwera lub domenę
    candidate       localhost;
}

vhost __defaultVhost__ {
    tcp_nodelay     on;
    min_latency     on;

    play {
        gop_cache       off;
        queue_length    10;
        mw_latency      100;
    }

    publish {
        mr off;
    }

    rtc {
        enabled     on;
        rtmp_to_rtc on;
        rtc_to_rtmp on;
    }

    hls {
        enabled  on;
        hls_fragment 2;
        hls_window 10;
    }

    dash {
        enabled         on;
        dash_fragment       2;
        dash_update_period  2;
        dash_timeshift      60;
        dash_path           ./objs/nginx/html;
        dash_mpd_file       [app]/[stream].mpd;
    }

    dvr {
        enabled     on;
        dvr_path    "./objs/nginx/html/[stream].[timestamp].mp4";
    }

    # forward {
    #     enabled     on;
    #     backend http://app:5000/forward;
    # }


    http_hooks {
        enabled         on;
        on_publish      http://app:5000/start;
        on_unpublish    http://app:5000/stop;
        on_dvr          http://app:5000/dvr;
    }
    
    # exec {
    #     enabled     on;
    #     # [app] i [stream] zastąpią się nazwami Twojego app i stream
    #     # to FFmpeg zrobi pull po HTTP-FLV i wypchnie pod RTMP
    #     publish     ./objs/ffmpeg/bin/ffmpeg -re -i [url] -c:v copy -c:a copy -f flv rtmp://127.0.0.1:1935/[app]/[stream];
    # }

    #   transcode {
    #     # whether the transcode enabled.
    #     # if off, donot transcode.
    #     # default: off.
    #     enabled     on;
    #     # the ffmpeg 
    #     ffmpeg      ./objs/ffmpeg/bin/ffmpeg;
    #     # the transcode engine for matched stream.
    #     # all matched stream will transcoded to the following stream.
    #     # the transcode set name(ie. hd) is optional and not used.
    #     engine 720p {
    #         enabled         on;
    #         vcodec          libx264;
    #         vwidth          1280;
    #         vheight         720;
    #         vthreads        2;
    #         vprofile        baseline;
    #         vpreset         veryfast;
            
    #         acodec          copy;
    #         achannels       2;
    #         output          rtmp://127.0.0.1:[port]/[app]?vhost=transcode/[stream]_[engine];
    #     }

    #     engine 480p {
    #         enabled         on;
    #         vcodec          libx264;
    #         vwidth          720;
    #         vheight         480;
    #         vthreads        2;
    #         vprofile        baseline;
    #         vpreset         fast;
            
    #         acodec          copy;
    #         achannels       2;
    #         output          rtmp://127.0.0.1:[port]/[app]?vhost=transcode/[stream]_[engine];
    #     }
        
    #     engine 360p {
    #         enabled         on;
    #         vcodec          libx264;
    #         vwidth          640;
    #         vheight         360;
    #         vthreads        2;
    #         vprofile        baseline;
    #         vpreset         fast;
            
    #         acodec          copy;
    #         achannels       2;
    #         output          rtmp://127.0.0.1:[port]/[app]?vhost=transcode/[stream]_[engine];
    #     }
    # }
    
    transcode {
    enabled on;
    ffmpeg ./objs/ffmpeg/bin/ffmpeg;
    
    engine 720p {
        enabled         on;
        iformat         flv;
        vcodec          libx265;           # HEVC zamiast H.264
        vbitrate        5000;              # Oszczędność 30% bitrate vs H.264
        vfps            0;
        vwidth          1280;
        vheight         720;
        vthreads        6;                 # HEVC wymaga więcej mocy obliczeniowej
        vprofile       main10;             # Profile dla HDR/10-bit
        vpreset        faster;             # Balans jakości i wydajności
        acodec          aac;
        abitrate        128;
        asample_rate    44100;
        achannels       2;
        oformat         flv;
        vparams {
            x265-params: "keyint=60:min-keyint=30:no-open-gop=1";  # Optymalizacje dla streamingu
        }
        output          rtmp://127.0.0.1:[port]/[app]?vhost=transcode/[stream]_720p;
    }

    engine 480p {
        enabled         on;
        iformat         flv;
        vcodec          libx265;
        vbitrate        2000;               # Oszczędność 30% bitrate vs H.264
        vfps            0;
        vwidth          720;
        vheight         480;
        vthreads        4;
        vprofile       main;
        vpreset        faster;
        acodec          aac;
        abitrate        96;
        asample_rate    44100;
        achannels       2;
        oformat         flv;
        output          rtmp://127.0.0.1:[port]/[app]?vhost=transcode/[stream]_480p;
    }
    
    engine 360p {
        enabled         on;
        iformat         flv;
        vcodec          libx265;
        vbitrate        1500;               # Oszczędność 30% bitrate vs H.264
        vfps            0;
        vwidth          640;
        vheight         360;
        vthreads        2;
        vprofile       main;
        vpreset        fast;              # Szybsze presety dla niższych rozdzielczości
        acodec          aac;
        abitrate        64;
        asample_rate    44100;
        achannels       2;
        oformat         flv;
        output          rtmp://127.0.0.1:[port]/[app]?vhost=transcode/[stream]_360p;
    }
}
}


vhost transcode{
    tcp_nodelay     on;
    min_latency     on;

    play {
        gop_cache       off;
        queue_length    10;
        mw_latency      100;
    }

    publish {
        mr off;
    }

    ingest {
        enabled         off;
    }
    
    rtc {
        enabled     off;
    }

    hls {
        enabled  on;
        hls_fragment 2;
        hls_window 10;
    }

    dash {
        enabled         on;
        dash_fragment       2;
        dash_update_period  2;
        dash_timeshift      60;
        dash_path           ./objs/nginx/html;
        dash_mpd_file       [app]/[stream].mpd;
    }

    http_hooks {
        enabled         off;
    }
}