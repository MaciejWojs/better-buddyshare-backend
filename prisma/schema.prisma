generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  // previewFeatures = ["postgresqlExtensions"]
  output          = "./generated/"
}

datasource db {
  provider   = "postgresql"
  extensions = [citext, pgcrypto]
}

model User {
  userId Int @id @unique @default(autoincrement()) @map("user_id")

  email    String @unique @db.Citext
  username String @unique @db.Citext
  password String

  createdAt DateTime @default(now()) @map("created_at")

  avatar        String @default("")
  profileBanner String @default("") @map("profile_banner")
  description   String @default("Default description")

  isBanned     Boolean   @default(false) @map("is_banned")
  banReason    String?   @map("ban_reason")
  banExpiresAt DateTime? @map("ban_expires_at")

  streamToken String? @default("") @map("stream_token")

  roles       UserRole[] @relation("UserRoles")
  streamRoles UserRole[] @relation("UserRoleStreamer")

  Stream        Stream[]
  Subscribers   Subscribers[] @relation("SubscriberUser")
  Subscriptions Subscribers[] @relation("SubscriberStreamer")

  bannedUsersAsStreamer BannedUsersPerStreamer[] @relation("BannedUserStreamer")
  bannedAsUser          BannedUsersPerStreamer[] @relation("BannedUser")
  bannedByMe            BannedUsersPerStreamer[] @relation("BannedByUser")
  RefreshToken          RefreshToken[]
  Session               Session[]
  ChatMessage           ChatMessage[]

  @@index([createdAt])
  @@map("users")
}

model Role {
  roleId      Int              @id @default(autoincrement()) @map("role_id")
  name        String           @unique // e.g. "admin", "support", "streamer"
  permissions RolePermission[]
  users       UserRole[]

  @@map("roles")
}

model UserRole {
  id         Int  @id @default(autoincrement()) @map("id")
  userID     Int  @map("user_id")
  roleID     Int  @map("role_id")
  streamerID Int? @map("streamer_id")

  user     User  @relation("UserRoles", fields: [userID], references: [userId])
  role     Role  @relation(fields: [roleID], references: [roleId])
  streamer User? @relation("UserRoleStreamer", fields: [streamerID], references: [userId])

  @@unique([userID, roleID, streamerID])
  @@map("user_roles")
}

model Permission {
  permissionId Int              @id @default(autoincrement()) @map("permission_id")
  name         String           @unique // e.g. "USER_MANAGE", "STREAMER_MANAGE"
  roles        RolePermission[]

  @@map("permissions")
}

model RolePermission {
  roleId       Int @map("role_id")
  permissionId Int @map("permission_id")

  role       Role       @relation(fields: [roleId], references: [roleId])
  permission Permission @relation(fields: [permissionId], references: [permissionId])

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model Stream {
  streamId Int @id @default(autoincrement()) @map("stream_id")

  streamerId  Int    @map("streamer_id")
  title       String @default("Untitled Stream")
  description String @default("No description provided")
  thumbnail   String @default("")

  isLive    Boolean   @default(false) @map("is_live")
  isPublic  Boolean   @default(false) @map("is_public")
  isLocked  Boolean   @default(false) @map("is_locked")
  startedAt DateTime  @default(now()) @map("started_at")
  endedAt   DateTime? @map("ended_at")
  path      String?

  streamer               User                     @relation(fields: [streamerId], references: [userId])
  ChatMessage            ChatMessage[]
  streamStatisticsInTime streamStatisticsInTime[]

  @@index([streamerId])
  @@index([isLive, startedAt])
  @@map("streams")
}

model Subscribers {
  subscriberId    Int      @id @default(autoincrement()) @map("subscription_id")
  userId          Int      @map("user_id")
  streamerId      Int      @map("streamer_id")
  subscribedSince DateTime @default(now()) @map("subscribed_since")

  user     User @relation("SubscriberUser", fields: [userId], references: [userId])
  streamer User @relation("SubscriberStreamer", fields: [streamerId], references: [userId])

  @@unique([userId, streamerId])
  @@index([userId])
  @@index([streamerId])
  @@map("subscribers")
}

model BannedUsersPerStreamer {
  bannedUserId Int       @id @default(autoincrement()) @map("ban_id")
  streamerId   Int       @map("streamer_id")
  userId       Int       @map("user_id")
  reason       String    @default("Unknown reason")
  bannedBy     Int       @map("banned_by")
  bannedSince  DateTime  @default(now()) @map("banned_since")
  bannedUntil  DateTime? @map("banned_until")
  isPermanent  Boolean   @default(true) @map("is_permanent")

  streamer     User @relation("BannedUserStreamer", fields: [streamerId], references: [userId])
  user         User @relation("BannedUser", fields: [userId], references: [userId])
  bannedByUser User @relation("BannedByUser", fields: [bannedBy], references: [userId])

  @@unique([streamerId, userId])
  @@index([bannedBy])
  @@index([bannedUntil])
  @@map("banned_users_per_streamer")
}

model RefreshToken {
  id           String    @id @default(uuid()) @map("token_id")
  tokenHash    String    @map("token_hash")
  userId       Int       @map("user_id")
  sessionId    String    @map("session_id")
  issuedAt     DateTime  @default(now()) @map("issued_at")
  expiresAt    DateTime  @map("expires_at")
  revokedAt    DateTime? @map("revoked_at")
  replacedById String?   @map("replaced_by_id")
  usedAt       DateTime? @map("used_at")

  user    User    @relation(fields: [userId], references: [userId])
  session Session @relation(fields: [sessionId], references: [id])

  replacedBy RefreshToken?  @relation("TokenReplacement", fields: [replacedById], references: [id])
  replaces   RefreshToken[] @relation("TokenReplacement")

  @@index([userId])
  @@index([sessionId])
  @@index([issuedAt])
  @@map("refresh_tokens")
}

model Session {
  id         String    @id @default(uuid()) @map("session_id")
  userId     Int       @map("user_id")
  ipAddress  String?   @map("ip_address")
  userAgent  String?   @map("user_agent")
  deviceInfo String?   @map("device_info")
  createdAt  DateTime  @default(now()) @map("created_at")
  lastUsedAt DateTime? @map("last_used_at")
  revokedAt  DateTime? @map("revoked_at")
  expiresAt  DateTime  @map("expires_at")
  isActive   Boolean   @default(true) @map("is_active")

  user          User           @relation(fields: [userId], references: [userId])
  refreshTokens RefreshToken[]

  @@index([userId, isActive])
  @@map("sessions")
}

model ChatMessage {
  messageId Int      @id @default(autoincrement()) @map("message_id")
  streamId  Int      @map("stream_id")
  userId    Int      @map("user_id")
  content   String   @map("content")
  sentAt    DateTime @default(now()) @map("sent_at")
  isDeleted Boolean  @default(false) @map("is_deleted")

  stream      Stream                   @relation(fields: [streamId], references: [streamId])
  user        User                     @relation(fields: [userId], references: [userId])
  editHistory ChatMessageEditHistory[] @relation("MessageEditHistory")

  @@index([streamId, sentAt])
  @@index([userId])
  @@index([isDeleted])
  @@map("chat_messages")
}

model streamStatisticsType {
  id                     Int                      @id @default(autoincrement()) @map("stream_statistic_type_id")
  name                   String                   @unique @map("name")
  description            String?                  @map("description")
  streamStatisticsInTime streamStatisticsInTime[]
  @@map("stream_statistics_types")
}

model streamStatisticsInTime {
  id                    Int      @id @default(autoincrement()) @map("statistic_in_time_id")
  streamId              Int      @map("stream_id")
  streamStatisticTypeId Int      @map("stream_statistic_type_id")
  value                 Int      @default(0) @map("value")
  timepoint             DateTime @default(now()) @map("timepoint")

  stream               Stream               @relation(fields: [streamId], references: [streamId])
  streamStatisticsType streamStatisticsType @relation(fields: [streamStatisticTypeId], references: [id])

  @@index([streamId, timepoint])
  @@index([streamStatisticTypeId])
  @@map("stream_statistics_in_time")
}

model ChatMessageEditHistory {
  id         Int      @id @default(autoincrement()) @map("edit_id")
  messageId  Int      @map("message_id")
  oldContent String   @map("old_content")
  editedAt   DateTime @default(now()) @map("edited_at")

  message ChatMessage @relation("MessageEditHistory", fields: [messageId], references: [messageId])

  @@index([messageId])
  @@index([editedAt])
  @@map("chat_message_edit_histories")
}
